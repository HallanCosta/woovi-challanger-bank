name: üöÄ Deploy to Production

on:
  workflow_dispatch:
  # push:
   # branches:
   #  - main

jobs:
  build:
    name: üèóÔ∏è Build & Deploy
    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/main'

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üïí Generate timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_ENV

      - name: üî® Creating .env files
        run: |
          echo -n "${{ secrets.PRODUCTION_DEPLOY_ENV_WEB }}" | tr -d '\r' > ./apps/web/.env
          echo -e "\nAPP_VERSION=${{ env.timestamp }}" >> ./apps/web/.env

          echo -n "${{ secrets.PRODUCTION_DEPLOY_ENV_SERVER }}" | tr -d '\r' > ./apps/server/.env
          echo -e "\nAPP_VERSION=${{ env.timestamp }}" >> ./apps/server/.env

      - name: üì¶ Setup pnpm
        run: npm install -g pnpm@10.0.0

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üîß Type generation & validation
        run: |
          pnpm schema &&
          pnpm relay

      - name: üë∑ Build project
        run: pnpm build

      - name: üö¢ Deploy to Production server
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          ARGS: '-rlgoDzvc -i'
          SOURCE: '.'
          REMOTE_HOST: ${{ secrets.PRODUCTION_HOST }}
          REMOTE_USER: ${{ secrets.PRODUCTION_SUDO_USERNAME }}
          EXCLUDE: '/.docker/, /k6/, docker-compose.yml, /apps/server/.turbo/, /apps/server/docs/, /apps/server/jest.config.js, /apps/server/mongodb-binaries/, /apps/server/scripts/, /apps/server/babelBarrel.js, /apps/server/.env.example, /apps/server/README.md, /apps/server/tsconfig.json, /apps/web/.turbo/, /apps/web/.next/cache/, /apps/web/.swc/, /apps/web/coverage/, /apps/web/data/, /apps/web/.env.example, /apps/web/.eslintrc.js, /apps/web/jest.*, /apps/web/tsconfig.tsbuildinfo, /apps/web/next-env.d.ts'
          TARGET: ${{ secrets.PRODUCTION_PROJECT_DIR }}

  deploy:
      name: üöÄ Restart Services
      runs-on: ubuntu-latest
      needs: build

      steps:
        - name: üèÅ Build on Production Server
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.PRODUCTION_HOST }}
            username: ${{ secrets.PRODUCTION_SUDO_USERNAME }}
            key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
            script: |
              cd ${{ secrets.PRODUCTION_PROJECT_DIR }}
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              nvm use 24
              echo "Installing dependencies..."
              pnpm install --frozen-lockfile
              echo "Building project..."
              pnpm build

        - name: üèÅ Reload Production Services
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.PRODUCTION_HOST }}
            username: ${{ secrets.PRODUCTION_SUDO_USERNAME }}
            key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
            script: |
              cd ${{ secrets.PRODUCTION_PROJECT_DIR }}
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              nvm use 24
              echo "Starting containers..."
              pnpm compose:up:production
              sleep 10
              echo "Starting MongoDB replica with PNPM..."
              pnpm mongo:replica
              echo "Stopping production servers..."
              pnpm stop:production
              echo "Starting production servers..."
              pnpm start:production
